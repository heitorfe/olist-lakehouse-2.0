# PR Validation Workflow
# Runs on all pull requests targeting main branch
# Validates code quality, runs tests, and validates Databricks bundle

name: PR Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'resources/**'
      - 'databricks.yml'
      - 'tests/**'
      - 'pyproject.toml'
      - '.sqlfluff'
      - '.github/workflows/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # SQL Linting with SQLFluff
  # ============================================================================
  sql-lint:
    name: SQL Lint (SQLFluff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-sqlfluff-${{ hashFiles('requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-sqlfluff-

      - name: Install SQLFluff
        run: pip install sqlfluff==3.0.7

      - name: Run SQLFluff Lint
        run: sqlfluff lint src/pipelines/ --dialect databricks --format github-annotation-native

  # ============================================================================
  # Python Linting with Ruff
  # ============================================================================
  python-lint:
    name: Python Lint (Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff Linter
        run: ruff check src/ tests/ --output-format=github

      - name: Run Ruff Formatter Check
        run: ruff format src/ tests/ --check --diff

  # ============================================================================
  # YAML Validation
  # ============================================================================
  yaml-validation:
    name: YAML Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: yamllint -c .yamllint.yml databricks.yml resources/

  # ============================================================================
  # Databricks Bundle Validation
  # ============================================================================
  bundle-validation:
    name: DAB Validate (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [dev, staging, prod]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        run: curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

      - name: Validate bundle for ${{ matrix.target }}
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: databricks bundle validate -t ${{ matrix.target }}

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for hardcoded credentials
        run: |
          # Check for common credential patterns in source files
          if grep -rE "(password|secret|api_key)\s*=\s*['\"][^'\"]+['\"]" src/ --include="*.py" 2>/dev/null; then
            echo "::error::Potential hardcoded credentials found!"
            exit 1
          fi
          echo "No hardcoded credentials found"

  # ============================================================================
  # Python Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-test-${{ hashFiles('requirements-dev.txt') }}

      - name: Install dependencies
        run: pip install -r requirements-dev.txt

      - name: Run tests
        run: pytest tests/ -v --tb=short --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================================================
  # Summary Job
  # ============================================================================
  pr-validation-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [sql-lint, python-lint, yaml-validation, bundle-validation, security-scan, unit-tests]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.sql-lint.result }}" == "failure" || \
                "${{ needs.python-lint.result }}" == "failure" || \
                "${{ needs.yaml-validation.result }}" == "failure" || \
                "${{ needs.bundle-validation.result }}" == "failure" || \
                "${{ needs.security-scan.result }}" == "failure" || \
                "${{ needs.unit-tests.result }}" == "failure" ]]; then
            echo "::error::One or more validation checks failed"
            exit 1
          fi
          echo "All validation checks passed!"
